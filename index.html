<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Mapa UE — Regiones de Chile</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet" />
  <style>
    html, body { margin:0; height:100%; background:#F1F1F1; font-family:system-ui,-apple-system,"Segoe UI",Roboto,Arial }
    #map { position:absolute; inset:0 }

    /* Toolbar (debajo del zoom) */
    .toolbar {
      position:absolute; top:76px; right:10px; z-index:2;
      display:flex; gap:8px; background:#fff; padding:6px; border-radius:10px;
      box-shadow:0 6px 16px rgba(0,0,0,.12);
    }
    .toolbar button {
      border:0; border-radius:8px; padding:6px 10px; cursor:pointer;
      background:#f3f3f3; font:600 12px/1 system-ui; color:#222;
    }
    .toolbar button.active { background:#201245; color:#fff }

    /* Popup */
    .mapboxgl-popup{ max-width:860px }
    .mapboxgl-popup-content{ border-radius:22px; padding:20px 22px; box-shadow:0 10px 30px rgba(0,0,0,.15) }
    .ux-popup h2{ margin:0 0 14px; font:800 24px/1.15 system-ui; color:#201245 }
    .ux-cards{ display:flex; gap:12px }
    .ux-card{ flex:1; border-radius:18px; text-align:center; padding:16px 10px; color:#201245 }
    .ux-card h3{ margin:0 0 6px; font:800 24px/1 system-ui }
    .ux-card p{ margin:0; font:14px/1.35 system-ui; color:#1e1e1e }
  </style>
</head>
<body>
  <div id="map"></div>

  <!-- Filtro UI -->
  <div class="toolbar">
    <button id="btnActivos" class="active" title="Oculta regiones con 0">Solo con actividad</button>
    <button id="btnTodos" title="Muestra también las regiones con 0">Mostrar todo</button>
  </div>

  <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
  <script>
  // Token público
  mapboxgl.accessToken = 'pk.eyJ1IjoidmhpcnNjaGJlcmciLCJhIjoiY21lYmh4NDB4MG85bDJrcHdib21veGNubiJ9.WyoHoI8fXYX3VkEb42vKXg';

  // Mapa + controles (zoom top-right, atribución compacta bottom-right)
  const map = new mapboxgl.Map({
    container: 'map',
    style: 'mapbox://styles/mapbox/light-v11',
    center: [-70.67, -33.45],
    zoom: 4.4,
    hash: true,
    attributionControl: false
  });
  map.addControl(new mapboxgl.NavigationControl({ showCompass:false }), 'top-right');
  map.addControl(new mapboxgl.AttributionControl({ compact:true }), 'bottom-right');

  // Expresiones robustas (conversión a número)
  const T_MAN = ['to-number', ['get','manuales'], 0];
  const T_MAL = ['to-number', ['get','maleta'], 0];
  const T_MOB = ['to-number', ['get','mobilelab'], 0];
  const TOTAL  = ['+', T_MAN, ['+', T_MAL, T_MOB]];

  // Anti-caché para siempre traer el último GeoJSON
  const DATA_URL = 'https://azullecaros.github.io/mapa-ue/regiones_chile_centros.geojson?v=' + Date.now();

  map.on('load', () => {
    map.addSource('regiones-centros', { type:'geojson', data: DATA_URL });

    // Círculos: lila si total>0, gris claro si total=0; sin borde
    map.addLayer({
      id: 'centros-circulos',
      type: 'circle',
      source: 'regiones-centros',
      paint: {
        'circle-color': ['case', ['==', TOTAL, 0], '#D9D9D9', '#E2D2F6'],
        'circle-stroke-width': 0,
        'circle-radius': [
          'case', ['==', TOTAL, 0], 8,
          ['interpolate', ['linear'], TOTAL, 0, 10, 300, 16, 800, 22, 1600, 30, 2600, 40]
        ]
      }
    });

    // Número total: no mostrar texto si total=0; color #201245
    map.addLayer({
      id: 'centros-texto',
      type: 'symbol',
      source: 'regiones-centros',
      layout: {
        'text-field': ['case', ['==', TOTAL, 0], '', ['to-string', TOTAL]],
        'text-size': 13,
        'text-font': ['Open Sans Bold','Arial Unicode MS Bold'],
        'text-allow-overlap': true,
        'text-ignore-placement': true
      },
      paint: {
        'text-color': '#201245',
        'text-halo-color': '#FFFFFF',
        'text-halo-width': 0.6
      }
    });

    // Popup con salto de línea antes del nombre para alinear
    map.on('click', 'centros-circulos', (e) => {
      const p = e.features[0].properties;
      const man = Number(p['manuales']||0);
      const mal = Number(p['maleta']||0);
      const mob = Number(p['mobilelab']||0);
      const titulo = (man+mal+mob) === 0 ? `${p['región']} — sin casos aún` : p['región'];

      const html = `
        <div class="ux-popup">
          <h2>${titulo}</h2>
          <div class="ux-cards">
            <div class="ux-card" style="background:#E2D2F6;">
              <h3>${man}</h3><p>usuarios de<br><strong>Manuales</strong></p>
            </div>
            <div class="ux-card" style="background:#89ACDB;">
              <h3>${mal}</h3><p>usuarios de<br><strong>Maleta</strong></p>
            </div>
            <div class="ux-card" style="background:#A3D7DE;">
              <h3>${mob}</h3><p>usuarios de<br><strong>MobileLab</strong></p>
            </div>
          </div>
        </div>`;
      new mapboxgl.Popup({ offset:16, closeButton:true, maxWidth:'860px' })
        .setLngLat(e.lngLat).setHTML(html).addTo(map);
    });

    map.on('mouseenter','centros-circulos',()=>map.getCanvas().style.cursor='pointer');
    map.on('mouseleave','centros-circulos',()=>map.getCanvas().style.cursor='');

    // --- Filtro Solo con actividad / Mostrar todo ---
    const btnActivos = document.getElementById('btnActivos');
    const btnTodos   = document.getElementById('btnTodos');

    function setOnlyActive(onlyActive){
      if (onlyActive) {
        map.setFilter('centros-circulos', ['>', TOTAL, 0]);
        map.setFilter('centros-texto',   ['>', TOTAL, 0]);
        btnActivos.classList.add('active'); btnTodos.classList.remove('active');
      } else {
        map.setFilter('centros-circulos', null);
        map.setFilter('centros-texto',   null);
        btnTodos.classList.add('active'); btnActivos.classList.remove('active');
      }
    }
    // Estado inicial: solo con actividad
    setOnlyActive(true);

    btnActivos.onclick = () => setOnlyActive(true);
    btnTodos.onclick   = () => setOnlyActive(false);
  });
  </script>
</body>
</html>





